# Please report PKGBUILD bugs at
# https://github.com/ystein/archlinux-aur-packages

# Maintainer: Yannik Stein <yannik.stein [at] gmail.com>
# Submitter: vbPadre <vbpadre [at] gmail.com>

pkgname=ajenti
pkgver=0.6.3
pkgrel=1
pkgdesc="An easy server administration frontend. Please report \
PKGBUILD bugs at https://github.com/ystein/archlinux-aur-packages."

arch=('any')
url="http://ajenti.org/"
license=('LGPL')
depends=('python2' 'python2-lxml' 'python2-pyopenssl' 'python2-feedparser' 'python2-gevent')
makedepends=('python2' 'python2-distribute')
optdepends=('python2-psutil: Task Manager plugin'
            'python2-beautifulsoup3: Munin plugin')
provides=('ajenti')
conflicts=('ajenti-git')
install='ajenti.install'
source=('http://repo.ajenti.org/debian/pool/main/a/ajenti/ajenti_0.6.3_all.deb'
         'ajenti.service')
md5sums=('923b65d018f4d6b2a6d86900b291a76b' 'a031fbf9543b000f72b7d0534e332c43')
backup=('etc/ajenti/ajenti.conf' 'etc/ajenti/users/admin.conf')

build() {
  [ -e data ] && rm -r data
  mkdir data
  tar xf data.tar.gz -C data

  msg2 'Replacing python shebang by python2 shebang...'
  find . -type f -exec sed -i \
    -e'1s|^#!/usr/bin/env python$|#!/usr/bin/env python2|' \
    -e '1s|^#!/usr/bin/python$|#!/usr/bin/env python2|' \
    "{}" \;
}

package() {
  install -D ajenti.service "$pkgdir/etc/systemd/system/ajenti.service"
  cp -r data/etc/ajenti "$pkgdir/etc"

  mkdir "$pkgdir/usr"
  cp -r data/usr/bin "$pkgdir/usr"
  cp -r data/usr/share/doc "$pkgdir/usr/share"

  mkdir -p "$pkgdir/usr/lib/python2.7"
  cp -r data/usr/share/pyshared/ajenti "$pkgdir/usr/lib/python2.7/ajenti"

  cp -r data/var "$pkgdir"

  msg2 'Fixing config file permissions...'
  chmod o-rwx "$pkgdir/etc/ajenti/ajenti.conf"
}
